name: Docker Image Build and Push To Docker Hub

on:
  push:
    branches:
      - main
    paths:
      - '**/*' # This will trigger whenever there are changes in any file in the repository
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker
        uses: docker/setup-buildx-action@v2

      - name: Login To Dockerhub With Dockerhub Credentials
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag Docker Image With Current Date and Timestamp
        id: get_datetime
        run: echo "timestamp=$(date +'%Y-%m-%d-%H-%M')" >> $GITHUB_OUTPUT
      
      - name: Build Docker Image
        run: |
          docker build -t wisdom2608/wisdomtech:${{ steps.get_datetime.outputs.timestamp }} . # Replace with your image name
      
      - name: Push Docker Image To Dockerhub Repository
        run: |
          docker push wisdom2608/wisdomtech:${{ steps.get_datetime.outputs.timestamp }} # Replace with your image name

      # # UPdate the K8s Manifest Files
      # - name: Update K8s Manifests
      #   run: |
      #     cat deploy/deploy.yaml
      #   #  sed -i "s|image: 1nfosecsingh/demo-app:.*|image: 1nfosecsingh/demo-app:${{ env.VERSION }}|g" deploy/deploy.yaml
      #     cat deploy/deploy.yaml

      - name: Update Kubernetes manifest with new tag
        run: |
          cat deployment/deploy.yaml
          sed -i "s/TAG_PLACEHOLDER/${{ steps.get_datetime.outputs.timestamp }}/g" deployment/deploy.yaml > deployment/deploy.yaml
          cat deployment/deploy.yaml
          echo "Updated deployment/deploy.yaml with new tag"
